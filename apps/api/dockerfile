# ---------- base ----------
FROM node:20.5.0-alpine AS base
WORKDIR /repo
RUN corepack enable


# ---------- builder ----------
FROM base AS builder
WORKDIR /repo

# Copy workspace configuration
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json tsconfig.json ./

# Copy ALL package.json files
COPY apps/api/package.json ./apps/api/
COPY apps/web/package.json ./apps/web/
COPY packages/utils/package.json ./packages/utils/

# Install ALL dependencies
RUN pnpm install --frozen-lockfile

# Copy all source code
COPY apps ./apps
COPY packages ./packages

# Build only the API and its dependencies
RUN pnpm turbo build --filter=@msgbits/api...

# Deploy creates fat node_modules with all dependencies
RUN pnpm --filter=@msgbits/api deploy --prod --legacy /prod/api

# Copy built files and runtime assets directly
RUN cp -r /repo/apps/api/config /prod/api/config
RUN cp -r /repo/apps/api/public /prod/api/public
RUN cp -r /repo/apps/api/templates /prod/api/templates


# ---------- production ----------
FROM node:20.5.0-alpine AS production

WORKDIR /app

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Copy everything from /prod/api (now has correct structure)
COPY --from=builder --chown=nodejs:nodejs /prod/api ./

# Environment variables
ENV NODE_ENV=production \
    NODE_CONFIG_DIR=/app/config \
    REDIS_HOST=redis \
    REDIS_PORT=6379

USER nodejs

EXPOSE 8080

CMD ["node", "dist/index.js"]
#CMD ["tail", "-f", "/dev/null"]

