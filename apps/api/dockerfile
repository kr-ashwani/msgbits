FROM node:20.5.0-alpine AS builder

WORKDIR /repo

# Enable pnpm
RUN corepack enable

# Copy workspace files
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json ./
COPY apps/api/package.json apps/api/package.json

# Install dependencies
RUN pnpm install --filter msgbits-api... --frozen-lockfile

# Copy backend source
COPY apps/api ./apps/api

WORKDIR /repo/apps/api

# Build with turbo
RUN pnpm turbo build


#-------- deploy stage --------
FROM node:20.5.0-alpine AS deploy

WORKDIR /repo

# Enable pnpm
RUN corepack enable

# Copy workspace files
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json ./
COPY apps/api/package.json apps/api/package.json

# Copy built artifacts from builder
COPY --from=builder /repo/apps/api/build ./apps/api/build
COPY --from=builder /repo/apps/api/build/config ./apps/api/config

# Use pnpm deploy to create pruned production dependencies
RUN pnpm deploy --filter=msgbits-api --prod --legacy /app


#-------- production --------
FROM node:20.5.0-alpine

WORKDIR /app

RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001

# Copy from deploy stage (already pruned with only production deps)
COPY --from=deploy /app ./

# Give nodejs user ownership of the entire app directory
RUN chown -R nodejs:nodejs /app

ENV NODE_ENV=production \
    REDIS_HOST=redis \
    REDIS_PORT=6379

USER nodejs
EXPOSE 8080
CMD ["npm", "start"]